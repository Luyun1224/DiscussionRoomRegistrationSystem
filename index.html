<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教學部討論室借用系統 (Google Sheet 版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f9ff; }
        .header-gradient { background: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%); }
        .btn-primary { background-color: #22c55e; color: white; transition: background-color: 0.3s; }
        .btn-primary:hover { background-color: #16a34a; }
        .btn-danger { background-color: #ef4444; color: white; transition: background-color: 0.3s; }
        .btn-danger:hover { background-color: #dc2626; }
        .modal-backdrop { transition: opacity 0.3s ease-in-out; }
        .time-slot-cell { transition: all 0.2s ease; position: relative; }
        .time-slot-cell.available:hover { background-color: #d1fae5; transform: scale(1.05); z-index: 10; }
        .booked-slot { display: flex; align-items: center; justify-content: center; padding: 4px; font-size: 0.8rem; color: white; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; line-height: 1.2; }
        .input-field { padding: 0.75rem; font-size: 1rem; }
        .header-text-shadow { text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.25); }
        #loader { transition: opacity 0.3s; }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- Loading Overlay -->
    <div id="loader" class="fixed inset-0 z-[99] bg-white bg-opacity-70 flex justify-center items-center pointer-events-none opacity-0">
        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-500"></div>
    </div>

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8 p-6 rounded-xl shadow-lg header-gradient">
            <h1 class="text-4xl font-bold text-white header-text-shadow">教學部討論室借用系統</h1>
            <p class="text-white/90 mt-2 header-text-shadow">即時查看與預約，讓會議安排更輕鬆！</p>
        </header>

        <div class="flex flex-col md:flex-row justify-center items-center mb-8 bg-white p-4 rounded-lg shadow-md gap-4">
            <label for="date-picker" class="text-lg font-semibold text-gray-700">選擇日期：</label>
            <input type="date" id="date-picker" class="border-2 border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-400 focus:border-blue-400">
        </div>

        <div class="bg-white rounded-2xl shadow-xl overflow-x-auto">
            <div id="schedule-container" class="min-w-[1200px] p-4 md:p-6 relative">
                <!-- Schedule grid will be generated here by JS -->
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="booking-modal" class="fixed inset-0 z-50 bg-black bg-opacity-50 flex justify-center items-center p-4 modal-backdrop opacity-0 pointer-events-none">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg transform scale-95 transition-transform duration-300">
            <h3 class="text-2xl font-bold mb-4 text-gray-800">預約時段</h3>
            <div class="bg-blue-50 p-4 rounded-lg mb-6">
                <div class="flex justify-between items-center text-center">
                    <div><p class="text-sm text-gray-500">房間</p><p id="modal-room-name" class="font-bold text-lg text-blue-600"></p></div>
                    <div><p class="text-sm text-gray-500">日期</p><p id="modal-date" class="font-semibold text-lg"></p></div>
                    <div><p class="text-sm text-gray-500">從</p><p id="modal-start-time" class="font-semibold text-lg"></p></div>
                    <div><p class="text-sm text-gray-500">到</p><select id="end-time-select" class="font-semibold text-lg bg-transparent border-none focus:ring-0 p-0 pr-7"></select></div>
                </div>
            </div>
            <div class="space-y-4">
                <div><label for="booker-name" class="block text-sm font-medium text-gray-700 mb-1">借用者姓名:</label><input type="text" id="booker-name" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 input-field" placeholder="例如：王大明"></div>
                <div><label for="booker-contact" class="block text-sm font-medium text-gray-700 mb-1">聯絡方式:</label><input type="text" id="booker-contact" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 input-field" placeholder="分機或手機號碼"></div>
                <div><label for="booking-purpose" class="block text-sm font-medium text-gray-700 mb-1">預定用途:</label><textarea id="booking-purpose" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 input-field" placeholder="例如：專案會議、部門訓練"></textarea></div>
            </div>
            <div class="mt-8 flex justify-end space-x-4">
                <button id="cancel-booking-btn" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">取消</button>
                <button id="confirm-booking-btn" class="px-6 py-2 btn-primary rounded-lg font-semibold">確認預約</button>
            </div>
        </div>
    </div>
    
    <div id="alert-modal" class="fixed inset-0 z-[60] bg-black bg-opacity-50 flex justify-center items-center p-4 modal-backdrop opacity-0 pointer-events-none">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-sm text-center">
            <p id="alert-message" class="text-lg mb-6"></p>
            <div id="alert-buttons" class="flex justify-center space-x-4"></div>
        </div>
    </div>

    <script type="module">
        // --- 設定區 ---
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx19UdR3V26vH3kSp7OUPaTnWmEw0bRA2jhzXZ7bY-Fi5khPakQqN8qncOIpGeDry2tBA/exec'; 
        // --- 設定區結束 ---

        let currentBookings = [];
        const rooms = [
            { id: 1, name: '討論室', color: 'bg-teal-500' },
            { id: 2, name: '多功能室', color: 'bg-orange-500' },
        ];
        
        const datePicker = document.getElementById('date-picker');
        const scheduleContainer = document.getElementById('schedule-container');
        const loader = document.getElementById('loader');
        const bookingModal = document.getElementById('booking-modal');
        const alertModal = document.getElementById('alert-modal');

        const showLoader = () => { loader.classList.remove('opacity-0', 'pointer-events-none'); };
        const hideLoader = () => { loader.classList.add('opacity-0', 'pointer-events-none'); };
        
        const generateTimeSlots = (interval = 30) => {
            const slots = [];
            for (let hour = 8; hour < 18; hour++) {
                for (let minute = 0; minute < 60; minute += interval) {
                    slots.push(`${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`);
                }
            }
            slots.push('18:00');
            return slots;
        };
        const timeSlots = generateTimeSlots();

        const customAlert = (message) => {
            return new Promise(resolve => {
                const alertMessage = document.getElementById('alert-message');
                const alertButtons = document.getElementById('alert-buttons');
                alertMessage.textContent = message;
                alertButtons.innerHTML = `<button id="alert-ok" class="px-6 py-2 btn-primary rounded-lg">確認</button>`;
                alertModal.classList.remove('opacity-0', 'pointer-events-none');
                document.getElementById('alert-ok').onclick = () => {
                    alertModal.classList.add('opacity-0', 'pointer-events-none');
                    resolve();
                };
            });
        };

        const customConfirm = (message) => {
            return new Promise(resolve => {
                const alertMessage = document.getElementById('alert-message');
                const alertButtons = document.getElementById('alert-buttons');
                alertMessage.textContent = message;
                alertButtons.innerHTML = `<button id="confirm-cancel" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg">取消</button><button id="confirm-ok" class="px-6 py-2 btn-danger rounded-lg">確定</button>`;
                alertModal.classList.remove('opacity-0', 'pointer-events-none');
                document.getElementById('confirm-ok').onclick = () => {
                    alertModal.classList.add('opacity-0', 'pointer-events-none');
                    resolve(true);
                };
                document.getElementById('confirm-cancel').onclick = () => {
                    alertModal.classList.add('opacity-0', 'pointer-events-none');
                    resolve(false);
                };
            });
        };

        const timeToMinutes = (time) => {
            if (typeof time !== 'string' || !time.includes(':')) return 0;
            const [hours, minutes] = time.split(':').map(Number);
            return hours * 60 + minutes;
        }

        const renderSchedule = (bookings) => {
            if (!Array.isArray(bookings)) {
                console.error("renderSchedule was called with non-array data:", bookings);
                bookings = []; 
            }
            currentBookings = bookings;
            scheduleContainer.innerHTML = ''; 

            const grid = document.createElement('div');
            grid.style.display = 'grid';
            grid.style.gridTemplateColumns = '100px repeat(20, minmax(0, 1fr))';
            grid.style.gridTemplateRows = `48px repeat(${rooms.length}, 80px)`;

            const headerVenue = document.createElement('div');
            headerVenue.className = "sticky top-0 bg-white z-10 p-2 border-b border-r font-semibold text-gray-600 flex items-center justify-center";
            headerVenue.style.gridRow = '1';
            headerVenue.style.gridColumn = '1';
            headerVenue.textContent = '場地';
            grid.appendChild(headerVenue);

            timeSlots.slice(0, -1).forEach((slot, index) => {
                const headerSlot = document.createElement('div');
                headerSlot.className = "sticky top-0 bg-white z-10 p-2 border-b text-center text-sm text-gray-500 flex items-center justify-center";
                headerSlot.style.gridRow = '1';
                headerSlot.style.gridColumn = `${index + 2}`;
                headerSlot.textContent = slot;
                grid.appendChild(headerSlot);
            });

            rooms.forEach((room, roomIndex) => {
                const roomLabel = document.createElement('div');
                roomLabel.className = `p-2 border-r flex items-center justify-center font-bold text-lg ${room.color.replace('bg-', 'text-')}`;
                roomLabel.style.gridRow = `${roomIndex + 2}`;
                roomLabel.style.gridColumn = '1';
                roomLabel.textContent = room.name;
                grid.appendChild(roomLabel);

                timeSlots.slice(0, -1).forEach((slot, slotIndex) => {
                    const cell = document.createElement('div');
                    cell.className = "time-slot-cell border-b border-r available cursor-pointer";
                    cell.dataset.roomName = room.name;
                    cell.dataset.timeSlot = slot;
                    cell.style.gridRow = `${roomIndex + 2}`;
                    cell.style.gridColumn = `${slotIndex + 2}`;
                    grid.appendChild(cell);
                });
            });

            scheduleContainer.appendChild(grid);
            
            if (bookings.length === 0) {
                const noBookingsMessage = document.createElement('div');
                noBookingsMessage.textContent = '本日尚無預約';
                noBookingsMessage.className = 'absolute inset-0 flex items-center justify-center text-gray-400 text-lg pointer-events-none';
                noBookingsMessage.style.top = '48px'; 
                scheduleContainer.appendChild(noBookingsMessage);
            }

            bookings.forEach(booking => {
                console.log("正在處理預約資料:", booking);

                const roomName = booking['場地名稱'];
                const startTime = booking['開始時間'];
                const endTime = booking['結束時間'];

                if (!startTime || !endTime || startTime === 'N/A' || endTime === 'N/A') {
                    console.error("此筆預約缺少有效的開始或結束時間:", booking);
                    return; 
                }

                const roomIndex = rooms.findIndex(r => r.name === roomName);
                if (roomIndex === -1) return;

                const startMinutes = timeToMinutes(startTime);
                const endMinutes = timeToMinutes(endTime);
                const gridStartMinutes = timeToMinutes('08:00');
                
                if (startMinutes < gridStartMinutes || endMinutes > timeToMinutes('18:00')) return;

                const offsetMinutes = startMinutes - gridStartMinutes;
                const durationMinutes = endMinutes - startMinutes;
                
                const startSlotIndex = Math.floor(offsetMinutes / 30);
                const durationSlots = Math.ceil(durationMinutes / 30);

                if (durationSlots <= 0) {
                    console.error("預約時長無效 (<= 0):", booking);
                    return;
                }
                
                const gridRowStart = roomIndex + 2;
                const gridColumnStart = startSlotIndex + 2;
                
                const roomColor = rooms[roomIndex].color;
                const bookingEl = document.createElement('div');
                bookingEl.className = `${roomColor} booked-slot rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer p-1`;
                
                bookingEl.style.gridRow = `${gridRowStart}`;
                bookingEl.style.gridColumn = `${gridColumnStart} / span ${durationSlots}`;
                bookingEl.style.zIndex = '20';
                bookingEl.style.margin = '4px';
                bookingEl.style.height = 'calc(100% - 8px)';
                bookingEl.dataset.bookingId = booking['預約ID'];

                const title = `預約者: ${booking['借用者']}\n用途: ${booking['預訂用途']}\n聯絡方式: ${booking['聯絡方式']}`;
                const displayText = `${booking['借用者']}<br><span class="text-xs opacity-80">${booking['預訂用途']}</span>`;
                bookingEl.innerHTML = `<div class="text-center w-full h-full flex flex-col justify-center items-center" title="${title}">${displayText}</div>`;
                
                grid.appendChild(bookingEl);
            });
        };
        
        async function fetchBookings() {
             if (WEB_APP_URL.includes('YOUR_WEB_APP_URL')) {
                await customAlert('系統尚未設定完成！請管理員依照教學文件，將 Web App URL 填入 HTML 檔案中。');
                return;
            }
            showLoader();
            try {
                const date = datePicker.value;
                const response = await fetch(`${WEB_APP_URL}?date=${date}`);
                if (!response.ok) throw new Error(`無法從 Google Sheet 讀取資料 (HTTP ${response.status})`);
                const result = await response.json();
                
                console.log("從後端收到的原始資料:", JSON.stringify(result, null, 2));

                if(result.status === 'error') throw new Error(result.message);
                
                renderSchedule(result.data || []);
            } catch (error) {
                console.error("Fetch bookings error:", error);
                await customAlert(`讀取預約資料失敗：${error.message}`);
                renderSchedule([]);
            } finally {
                hideLoader();
            }
        }

        const showModal = (roomName, startTime) => {
            document.getElementById('modal-room-name').textContent = roomName;
            document.getElementById('modal-date').textContent = datePicker.value;
            document.getElementById('modal-start-time').textContent = startTime;
            
            const endTimeSelect = document.getElementById('end-time-select');
            endTimeSelect.innerHTML = '';
            
            const roomBookingsToday = currentBookings.filter(b => b['場地名稱'] === roomName);
            const startIndex = timeSlots.indexOf(startTime);
            
            for (let i = startIndex + 1; i < timeSlots.length; i++) {
                const slotTime = timeSlots[i];
                const option = document.createElement('option');
                option.value = slotTime;
                option.textContent = slotTime;
                endTimeSelect.appendChild(option);
                
                const nextBookingTime = roomBookingsToday
                    .filter(b => timeToMinutes(b['開始時間']) > timeToMinutes(startTime))
                    .sort((a,b) => timeToMinutes(a['開始時間']) - timeToMinutes(b['開始時間']))
                    [0];
                
                if (nextBookingTime && timeToMinutes(slotTime) > timeToMinutes(nextBookingTime['開始時間'])) {
                    endTimeSelect.removeChild(option);
                    break;
                }
            }
            if (endTimeSelect.options.length === 0 && startIndex < timeSlots.length - 1) {
                 const option = document.createElement('option');
                 option.value = timeSlots[startIndex+1];
                 option.textContent = timeSlots[startIndex+1];
                 endTimeSelect.appendChild(option);
            }


            ['booker-name', 'booker-contact', 'booking-purpose'].forEach(id => document.getElementById(id).value = '');
            bookingModal.querySelector('div').dataset.roomName = roomName;
            bookingModal.querySelector('div').dataset.startTime = startTime;
            bookingModal.classList.remove('opacity-0', 'pointer-events-none');
            bookingModal.querySelector('div').classList.remove('scale-95');
        };

        const hideModal = () => {
             bookingModal.classList.add('opacity-0', 'pointer-events-none');
             bookingModal.querySelector('div').classList.add('scale-95');
        };

        const handleConfirmBooking = async () => {
            const name = document.getElementById('booker-name').value.trim();
            const contact = document.getElementById('booker-contact').value.trim();
            const purpose = document.getElementById('booking-purpose').value.trim();

            if (!name || !contact || !purpose) {
                await customAlert('所有欄位皆為必填！');
                return;
            }
            
            const { roomName, startTime } = bookingModal.querySelector('div').dataset;
            const endTime = document.getElementById('end-time-select').value;
            const date = datePicker.value;

            const bookingData = {
                action: 'book',
                payload: { date, roomName, startTime, endTime, bookerName: name, contact: contact, purpose: purpose }
            };
            
            showLoader();
            try {
                const response = await fetch(WEB_APP_URL, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(bookingData)
                });
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message || '預約失敗');
                
                hideLoader(); 
                hideModal();
                renderSchedule(result.data);
                await customAlert('預約成功！');
            } catch (error) {
                hideLoader(); 
                console.error("Booking error:", error);
                await customAlert(`預約失敗：${error.message}`);
            }
        };
        
        scheduleContainer.addEventListener('click', (e) => {
            const availableCell = e.target.closest('.time-slot-cell.available');
            const bookedSlot = e.target.closest('.booked-slot');

            if (availableCell) {
                const { roomName, timeSlot } = availableCell.dataset;
                showModal(roomName, timeSlot);
            }
            if (bookedSlot) {
                const bookingId = bookedSlot.dataset.bookingId;
                handleCancelBooking(bookingId);
            }
        });

        async function handleCancelBooking(bookingId) {
            const booking = currentBookings.find(b => b['預約ID'] === bookingId);
            if(!booking) return;

            const confirmed = await customConfirm(`您確定要取消 ${booking['借用者']} 於 ${booking['開始時間']}-${booking['結束時間']} 的預約嗎？`);
            if (!confirmed) return;

            showLoader();
            try {
                 const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'cancel', payload: { bookingId: bookingId } })
                });
                const result = await response.json();
                 if (result.status !== 'success') throw new Error(result.message || '取消失敗');

                hideLoader();
                renderSchedule(result.data);
                await customAlert('取消成功！');
            } catch (error) {
                hideLoader(); 
                console.error("Cancellation error:", error);
                await customAlert(`取消預約失敗：${error.message}`);
            }
        };

        document.getElementById('confirm-booking-btn').addEventListener('click', handleConfirmBooking);
        document.getElementById('cancel-booking-btn').addEventListener('click', hideModal);
        
        window.addEventListener('load', () => {
            const today = new Date();
            datePicker.value = today.toISOString().split('T')[0];
            fetchBookings();
            datePicker.addEventListener('change', fetchBookings);
        });
    </script>
</body>
</html>

