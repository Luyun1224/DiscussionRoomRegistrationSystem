<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>奇美醫院教學部討論室借用系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Tippy.js for custom tooltips --><script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <style>
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f7f9fa; /* 改為非常淺的灰色 */
        }
        /* 參考新的藍橘配色 */
        .header-gradient { 
            background: #223a5e; /* 深藍色底色 */
        }
        .btn-primary { 
            background-color: #f39c12; /* 亮橘色 */
            color: white; 
            transition: background-color: 0.3s; 
        }
        .btn-primary:hover { 
            background-color: #e67e22; /* 稍深的橘色 */
        }
        .btn-danger { 
            background-color: #e74c3c; /* 經典紅色 */
            color: white; 
            transition: background-color: 0.3s; 
        }
        .btn-danger:hover { 
            background-color: #c0392b; 
        }
        .modal-backdrop { transition: opacity 0.3s ease-in-out; }
        .time-slot-cell { transition: all 0.2s ease; position: relative; }
        .time-slot-cell.available:hover { 
            background-color: #fef5e7; /* 淺橘色 hover */
            transform: scale(1.05); 
            z-index: 10; 
        }
        .booked-slot { 
            display: flex; align-items: center; justify-content: center; padding: 4px; font-size: 0.8rem; color: white; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; line-height: 1.2; 
        }
        .input-field { 
            padding: 0.75rem; font-size: 1rem; 
        }
        .header-text-shadow { 
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.25); 
        }
        #loader { transition: opacity 0.3s; }
        /* Calendar Styles */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { 
            background-color: #fff; 
            border: 1px solid #eef2f5; /* 淺灰藍邊框 */
            border-radius: 0.5rem; 
            padding: 8px; 
            transition: all 0.2s; 
            cursor: pointer; 
            display: flex; 
            flex-direction: column;
            min-height: 90px;
        }
        .calendar-day:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .calendar-day.other-month { background-color: #fcfdfd; color: #9ca3af; cursor: not-allowed; }
        .calendar-day.is-today .day-number { font-weight: bold; color: #f39c12; } /* 配合新的主色 (橘色) */
        .calendar-day.is-selected { background-color: #dbe4f0; border-color: #223a5e; } /* 選中狀態 (淺藍) */
        .calendar-day.is-weekend .day-number { color: #c0392b; } /* 柔和的週末紅 */
        .booking-dot { min-width: 8px; width: 8px; height: 8px; border-radius: 50%; }
        .calendar-booking-item { display: flex; align-items: center; font-size: 0.7rem; margin-top: 2px; overflow: hidden; }
        .holiday-name { font-size: 0.65rem; color: #c0392b; text-align: center; font-weight: 500; margin-top: auto; }
        /* Custom Tippy.js Tooltip Style */
        .tippy-box[data-theme~='light-border'] {
            background-color: #ffffff;
            color: #334155;
            border: 2px solid #223a5e; /* 配合新的主色 (深藍) */
            border-radius: 8px;
            font-family: 'Noto Sans TC', sans-serif;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .tippy-box[data-theme~='light-border'][data-placement^='top'] > .tippy-arrow::before { border-top-color: #223a5e; }
        .tippy-box[data-theme~='light-border'][data-placement^='bottom'] > .tippy-arrow::before { border-bottom-color: #223a5e; }
        .tippy-content { padding: 8px 12px; white-space: pre-wrap; }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- Loading Overlay --><div id="loader" class="fixed inset-0 z-[99] bg-white bg-opacity-70 flex justify-center items-center pointer-events-none opacity-0">
        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-500"></div>
    </div>

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8 p-6 rounded-xl shadow-lg header-gradient">
            <h1 class="text-4xl font-bold text-white header-text-shadow">奇美醫院教學部討論室借用系統</h1>
            <p class="text-white/90 mt-2 header-text-shadow">即時查看與預約，讓會議安排更輕鬆！</p>
        </header>

        <div class="flex flex-col md:flex-row justify-center items-center mb-8 bg-white p-4 rounded-lg shadow-md gap-4">
            <label for="date-picker" class="text-lg font-semibold text-gray-700">選擇日期：</label>
            <input type="date" id="date-picker" class="border-2 border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-400 focus:border-blue-400">
        </div>

        <div class="bg-white rounded-2xl shadow-xl overflow-x-auto mb-8">
            <div id="schedule-container" class="min-w-[1200px] p-4 md:p-6 relative">
                <!-- Schedule grid will be generated here by JS --></div>
        </div>

        <!-- Calendar Section --><div id="calendar-wrapper" class="bg-white rounded-2xl shadow-xl p-4 md:p-6">
            <div>
                <div id="calendar-header" class="flex justify-between items-center mb-4">
                    <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-100">&lt;</button>
                    <h2 id="calendar-month-year" class="text-xl font-bold"></h2>
                    <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-100">&gt;</button>
                </div>
                <div class="grid grid-cols-7 text-center font-semibold text-gray-500 mb-2">
                    <div class="text-red-700">日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div class="text-red-700">六</div>
                </div>
                <div id="calendar-grid" class="calendar-grid">
                    <!-- Calendar days will be generated here by JS --></div>
            </div>
        </div>
    </div>

    <!-- Modals (same as before) --><div id="booking-modal" class="fixed inset-0 z-50 bg-black bg-opacity-50 flex justify-center items-center p-4 modal-backdrop opacity-0 pointer-events-none">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg transform scale-95 transition-transform duration-300">
            <h3 class="text-2xl font-bold mb-4 text-gray-800">預約時段</h3>
            <div class="bg-amber-50 p-4 rounded-lg mb-6">
                <div class="flex justify-between items-center text-center">
                    <div><p class="text-sm text-gray-500">房間</p><p id="modal-room-name" class="font-bold text-lg text-amber-600"></p></div>
                    <div><p class="text-sm text-gray-500">日期</p><p id="modal-date" class="font-semibold text-lg"></p></div>
                    <div><p class="text-sm text-gray-500">從</p><p id="modal-start-time" class="font-semibold text-lg"></p></div>
                    <div><p class="text-sm text-gray-500">到</p><select id="end-time-select" class="font-semibold text-lg bg-transparent border-none focus:ring-0 p-0 pr-7"></select></div>
                </div>
            </div>
            <div class="space-y-4">
                <div><label for="booker-name" class="block text-sm font-medium text-gray-700 mb-1">借用者姓名:</label><input type="text" id="booker-name" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-amber-500 focus:border-amber-500 input-field" placeholder="例如：王大明"></div>
                <div><label for="booker-contact" class="block text-sm font-medium text-gray-700 mb-1">聯絡方式:</label><input type="text" id="booker-contact" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-amber-500 focus:border-amber-500 input-field" placeholder="分機或手機號碼"></div>
                <div><label for="booking-purpose" class="block text-sm font-medium text-gray-700 mb-1">預定用途:</label><textarea id="booking-purpose" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-amber-500 focus:border-amber-500 input-field" placeholder="例如：專案會議、部門訓練"></textarea></div>
            </div>
            <div class="mt-8 flex justify-end space-x-4">
                <button class="close-modal-btn px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">關閉</button>
                <button id="confirm-booking-btn" class="px-6 py-2 btn-primary rounded-lg font-semibold">確認預約</button>
            </div>
        </div>
    </div>
    <div id="edit-modal" class="fixed inset-0 z-50 bg-black bg-opacity-50 flex justify-center items-center p-4 modal-backdrop opacity-0 pointer-events-none">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-lg transform scale-95 transition-transform duration-300">
            <h3 class="text-2xl font-bold mb-4 text-gray-800">編輯預約</h3>
            <div class="bg-blue-50 p-4 rounded-lg mb-6">
                <div class="flex justify-between items-center text-center">
                    <div><p class="text-sm text-gray-500">房間</p><p id="edit-modal-room-name" class="font-bold text-lg text-blue-600"></p></div>
                    <div><p class="text-sm text-gray-500">日期</p><p id="edit-modal-date" class="font-semibold text-lg"></p></div>
                    <div><p class="text-sm text-gray-500">從</p><p id="edit-modal-start-time" class="font-semibold text-lg"></p></div>
                    <div><p class="text-sm text-gray-500">到</p><select id="edit-end-time-select" class="font-semibold text-lg bg-transparent border-none focus:ring-0 p-0 pr-7"></select></div>
                </div>
            </div>
            <div class="space-y-4">
                <div><label for="edit-booker-name" class="block text-sm font-medium text-gray-700 mb-1">借用者姓名:</label><input type="text" id="edit-booker-name" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 input-field"></div>
                <div><label for="edit-booker-contact" class="block text-sm font-medium text-gray-700 mb-1">聯絡方式:</label><input type="text" id="edit-booker-contact" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 input-field"></div>
                <div><label for="edit-booking-purpose" class="block text-sm font-medium text-gray-700 mb-1">預定用途:</label><textarea id="edit-booking-purpose" rows="3" class="w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 input-field"></textarea></div>
            </div>
            <div class="mt-8 flex justify-between items-center">
                 <button id="trigger-cancel-btn" class="px-6 py-2 btn-danger rounded-lg font-semibold">取消此預約</button>
                 <div class="space-x-4">
                    <button class="close-modal-btn px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">關閉</button>
                    <button id="confirm-edit-btn" class="px-6 py-2 btn-primary rounded-lg font-semibold">儲存變更</button>
                 </div>
            </div>
        </div>
    </div>
    <div id="alert-modal" class="fixed inset-0 z-[60] bg-black bg-opacity-50 flex justify-center items-center p-4 modal-backdrop opacity-0 pointer-events-none">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-sm text-center">
            <p id="alert-message" class="text-lg mb-6"></p>
            <div id="alert-buttons" class="flex justify-center space-x-4"></div>
        </div>
    </div>

    <script type="module">
        // --- 設定區 ---
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx19UdR3V26vH3kSp7OUPaTnWmEw0bRA2jhzXZ7bY-Fi5khPakQqN8qncOIpGeDry2tBA/exec'; 
        const HOLIDAY_API_URL = 'https://cdn.jsdelivr.net/gh/ruyut/TaiwanCalendar/data/{year}.json';
        // --- 設定區結束 ---

        let currentDailyBookings = []; 
        let currentMonthBookings = []; 
        let calendarDate = new Date(); 
        let holidays = {};
        let tippyInstances = [];
        
        // 調整房間顏色以符合新的配色風格
        const rooms = [
            { id: 1, name: '討論室', color: 'bg-blue-900' }, // 深藍色
            { id: 2, name: '多功能室', color: 'bg-amber-500' }, // 琥珀色/橘色
        ];
        
        // DOM Elements
        const datePicker = document.getElementById('date-picker');
        const scheduleContainer = document.getElementById('schedule-container');
        const loader = document.getElementById('loader');
        const bookingModal = document.getElementById('booking-modal');
        const editModal = document.getElementById('edit-modal');
        const alertModal = document.getElementById('alert-modal');
        const calendarGrid = document.getElementById('calendar-grid');
        const calendarMonthYear = document.getElementById('calendar-month-year');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');

        const showLoader = () => { loader.classList.remove('opacity-0', 'pointer-events-none'); };
        const hideLoader = () => { loader.classList.add('opacity-0', 'pointer-events-none'); };
        
        const generateTimeSlots = (interval = 30) => {
            const slots = [];
            for (let hour = 8; hour < 18; hour++) {
                for (let minute = 0; minute < 60; minute += interval) {
                    slots.push(`${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`);
                }
            }
            slots.push('18:00');
            return slots;
        };
        const timeSlots = generateTimeSlots();

        const customAlert = (message) => {
            return new Promise(resolve => {
                const alertMessage = document.getElementById('alert-message');
                const alertButtons = document.getElementById('alert-buttons');
                alertMessage.textContent = message;
                alertButtons.innerHTML = `<button id="alert-ok" class="px-6 py-2 btn-primary rounded-lg">確認</button>`;
                alertModal.classList.remove('opacity-0', 'pointer-events-none');
                document.getElementById('alert-ok').onclick = () => {
                    alertModal.classList.add('opacity-0', 'pointer-events-none');
                    resolve();
                };
            });
        };

        const customConfirm = (message) => {
            return new Promise(resolve => {
                const alertMessage = document.getElementById('alert-message');
                const alertButtons = document.getElementById('alert-buttons');
                alertMessage.textContent = message;
                alertButtons.innerHTML = `<button id="confirm-cancel" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg">取消</button><button id="confirm-ok" class="px-6 py-2 btn-danger rounded-lg">確定</button>`;
                alertModal.classList.remove('opacity-0', 'pointer-events-none');
                document.getElementById('confirm-ok').onclick = () => {
                    alertModal.classList.add('opacity-0', 'pointer-events-none');
                    resolve(true);
                };
                document.getElementById('confirm-cancel').onclick = () => {
                    alertModal.classList.add('opacity-0', 'pointer-events-none');
                    resolve(false);
                };
            });
        };

        const timeToMinutes = (time) => {
            if (typeof time !== 'string' || !time.includes(':')) return 0;
            const [hours, minutes] = time.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        const formatDate = (date) => {
            const d = new Date(date);
            // Use local timezone to prevent off-by-one day errors
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const renderSchedule = (bookings) => {
            currentDailyBookings = Array.isArray(bookings) ? bookings : [];
            scheduleContainer.innerHTML = ''; 

            const grid = document.createElement('div');
            grid.style.display = 'grid';
            grid.style.gridTemplateColumns = '100px repeat(20, minmax(0, 1fr))';
            grid.style.gridTemplateRows = `48px repeat(${rooms.length}, 80px)`;

            const headerVenue = document.createElement('div');
            headerVenue.className = "sticky top-0 bg-white z-10 p-2 border-b border-r font-semibold text-gray-600 flex items-center justify-center";
            headerVenue.style.gridRow = '1';
            headerVenue.style.gridColumn = '1';
            headerVenue.textContent = '場地';
            grid.appendChild(headerVenue);

            timeSlots.slice(0, -1).forEach((slot, index) => {
                const headerSlot = document.createElement('div');
                headerSlot.className = "sticky top-0 bg-white z-10 p-2 border-b text-center text-sm text-gray-500 flex items-center justify-center";
                headerSlot.style.gridRow = '1';
                headerSlot.style.gridColumn = `${index + 2}`;
                headerSlot.textContent = slot;
                grid.appendChild(headerSlot);
            });

            rooms.forEach((room, roomIndex) => {
                const roomLabel = document.createElement('div');
                roomLabel.className = `p-2 border-r flex items-center justify-center font-bold text-lg ${room.color.replace('bg-', 'text-')}`;
                roomLabel.style.gridRow = `${roomIndex + 2}`;
                roomLabel.style.gridColumn = '1';
                roomLabel.textContent = room.name;
                grid.appendChild(roomLabel);

                timeSlots.slice(0, -1).forEach((slot, slotIndex) => {
                    const cell = document.createElement('div');
                    cell.className = "time-slot-cell border-b border-r available cursor-pointer";
                    cell.dataset.roomName = room.name;
                    cell.dataset.timeSlot = slot;
                    cell.style.gridRow = `${roomIndex + 2}`;
                    cell.style.gridColumn = `${slotIndex + 2}`;
                    grid.appendChild(cell);
                });
            });

            scheduleContainer.appendChild(grid);
            
            if (currentDailyBookings.length === 0) {
                const noBookingsMessage = document.createElement('div');
                noBookingsMessage.textContent = '本日尚無預約';
                noBookingsMessage.className = 'absolute inset-0 flex items-center justify-center text-gray-400 text-lg pointer-events-none';
                noBookingsMessage.style.top = '48px'; 
                scheduleContainer.appendChild(noBookingsMessage);
            }

            currentDailyBookings.forEach(booking => {
                const { '場地名稱': roomName, '開始時間': startTime, '結束時間': endTime, '預約ID': bookingId, '借用者': booker, '預訂用途': purpose, '聯絡方式': contact } = booking;
                if (!startTime || !endTime || startTime === 'N/A' || endTime === 'N/A') return; 
                const roomIndex = rooms.findIndex(r => r.name === roomName);
                if (roomIndex === -1) return;
                const startMinutes = timeToMinutes(startTime);
                const endMinutes = timeToMinutes(endTime);
                const gridStartMinutes = timeToMinutes('08:00');
                if (startMinutes < gridStartMinutes || endMinutes > timeToMinutes('18:00')) return;
                const offsetMinutes = startMinutes - gridStartMinutes;
                const durationMinutes = endMinutes - startMinutes;
                const startSlotIndex = Math.floor(offsetMinutes / 30);
                const durationSlots = Math.ceil(durationMinutes / 30);
                if (durationSlots <= 0) return;
                const gridRowStart = roomIndex + 2;
                const gridColumnStart = startSlotIndex + 2;
                const roomColor = rooms[roomIndex].color;
                const bookingEl = document.createElement('div');
                bookingEl.className = `${roomColor} booked-slot rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer p-1`;
                bookingEl.style.gridRow = `${gridRowStart}`;
                bookingEl.style.gridColumn = `${gridColumnStart} / span ${durationSlots}`;
                bookingEl.style.zIndex = '20';
                bookingEl.style.margin = '4px';
                bookingEl.style.height = 'calc(100% - 8px)';
                bookingEl.dataset.bookingId = bookingId;
                const title = `預約者: ${booker}\n用途: ${purpose}\n聯絡方式: ${contact}`;
                const displayText = `${booker}<br><span class="text-xs opacity-80">${purpose}</span>`;
                bookingEl.innerHTML = `<div class="text-center w-full h-full flex flex-col justify-center items-center" title="${title}">${displayText}</div>`;
                grid.appendChild(bookingEl);
            });
        };

        const renderScheduleFromMonthData = (dateString) => {
            const dailyData = currentMonthBookings.filter(b => b['預約日期'] === dateString);
            renderSchedule(dailyData);
        }

        const renderCalendar = (date, monthBookings) => {
            tippyInstances.forEach(instance => instance.destroy());
            tippyInstances = [];
            currentMonthBookings = Array.isArray(monthBookings) ? monthBookings : [];
            calendarGrid.innerHTML = '';
            calendarMonthYear.textContent = `${date.getFullYear()} 年 ${date.getMonth() + 1} 月`;
            
            const todayStr = formatDate(new Date());
            const selectedDateStr = datePicker.value;

            const year = date.getFullYear();
            const month = date.getMonth();

            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDayOfWeek = firstDayOfMonth.getDay();

            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = "calendar-day other-month";
                calendarGrid.appendChild(emptyCell);
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = "calendar-day";
                const thisDate = new Date(year, month, day);
                const thisDateStr = formatDate(thisDate);
                const dayOfWeek = thisDate.getDay();
                dayCell.dataset.date = thisDateStr;

                const dayNumber = document.createElement('span');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);

                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const holidayInfo = holidays[thisDateStr.replace(/-/g, '')];

                if (thisDateStr === todayStr) dayCell.classList.add('is-today');
                if (thisDateStr === selectedDateStr) dayCell.classList.add('is-selected');
                if (isWeekend || holidayInfo) dayCell.classList.add('is-weekend');

                
                const bookingsForDay = currentMonthBookings.filter(b => b['預約日期'] === thisDateStr).sort((a,b) => timeToMinutes(a['開始時間']) - timeToMinutes(b['開始時間']));
                
                const detailsContainer = document.createElement('div');
                detailsContainer.className = 'flex-grow overflow-hidden';
                dayCell.appendChild(detailsContainer);

                if (bookingsForDay.length > 0) {
                    bookingsForDay.slice(0, 2).forEach(booking => {
                        const room = rooms.find(r => r.name === booking['場地名稱']);
                        if (room) {
                            const item = document.createElement('div');
                            item.className = 'calendar-booking-item';
                            item.innerHTML = `
                                <div class="booking-dot ${room.color} mr-1"></div>
                                <span class="truncate">${booking['開始時間']}-${booking['結束時間']}</span>
                            `;
                            detailsContainer.appendChild(item);
                        }
                    });

                    if (bookingsForDay.length > 2) {
                        const more = document.createElement('div');
                        more.className = 'text-xs text-gray-500 text-center';
                        more.textContent = `還有 ${bookingsForDay.length - 2} 項...`;
                        detailsContainer.appendChild(more);
                    }
                }
                
                if (holidayInfo) {
                    const holidayEl = document.createElement('div');
                    holidayEl.className = 'holiday-name truncate';
                    holidayEl.textContent = holidayInfo.name;
                    detailsContainer.appendChild(holidayEl);
                }

                if (bookingsForDay.length > 0) {
                    const tooltipContent = bookingsForDay.map(b => 
                        `<strong>${b['場地名稱']} (${b['開始時間']}-${b['結束時間']})</strong><br>預約者: ${b['借用者']}<br>用途: ${b['預訂用途']}`
                    ).join('<hr class="my-2">');
                    
                    const instance = tippy(dayCell, {
                        content: tooltipContent,
                        allowHTML: true,
                        theme: 'light-border',
                        placement: 'top',
                    });
                    tippyInstances.push(instance);
                }

                calendarGrid.appendChild(dayCell);
            }
        };

        async function fetchHolidays(year) {
            if (holidays[year]) return;
            try {
                const response = await fetch(HOLIDAY_API_URL.replace('{year}', year));
                const data = await response.json();
                const holidayMap = {};
                data.forEach(item => {
                    if (item.isHoliday) {
                        holidayMap[item.date] = { name: item.name };
                    }
                });
                holidays = { ...holidays, ...holidayMap };
            } catch (error) {
                console.error(`無法載入 ${year} 年的假日資訊:`, error);
            }
        }

        async function updateCalendarView() {
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth() + 1;
            const monthString = `${year}-${String(month).padStart(2, '0')}`;
            
            showLoader();
            try {
                await fetchHolidays(year);
                const response = await fetch(`${WEB_APP_URL}?month=${monthString}`);
                if (!response.ok) throw new Error('無法讀取月曆資料');
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                // 載入月曆資料，並將資料存入 currentMonthBookings
                renderCalendar(calendarDate, result.data); 
            } catch (error) {
                console.error("Fetch month bookings error:", error);
                await customAlert(`讀取月曆資料失敗: ${error.message}`);
                renderCalendar(calendarDate, []); // 即使失敗也渲染空日曆
            } finally {
                hideLoader();
            }
        }
        
        function showBookingModal(roomName, startTime) {
            bookingModal.classList.remove('opacity-0', 'pointer-events-none');
            bookingModal.querySelector('div').classList.remove('scale-95');
            document.getElementById('modal-room-name').textContent = roomName;
            document.getElementById('modal-date').textContent = datePicker.value;
            document.getElementById('modal-start-time').textContent = startTime;
            const endTimeSelect = document.getElementById('end-time-select');
            const roomBookingsToday = currentDailyBookings.filter(b => b['場地名稱'] === roomName);
            const startIndex = timeSlots.indexOf(startTime);
            populateEndTimeSelect(endTimeSelect, startIndex, roomBookingsToday);
            ['booker-name', 'booker-contact', 'booking-purpose'].forEach(id => document.getElementById(id).value = '');
        };
        
        function showEditModal(booking) {
            editModal.classList.remove('opacity-0', 'pointer-events-none');
            editModal.querySelector('div').classList.remove('scale-95');
            editModal.dataset.bookingId = booking['預約ID'];
            document.getElementById('edit-modal-room-name').textContent = booking['場地名稱'];
            document.getElementById('edit-modal-date').textContent = booking['預約日期'];
            document.getElementById('edit-modal-start-time').textContent = booking['開始時間'];
            document.getElementById('edit-booker-name').value = booking['借用者'];
            document.getElementById('edit-booker-contact').value = booking['聯絡方式'];
            document.getElementById('edit-booking-purpose').value = booking['預訂用途'];
            const endTimeSelect = document.getElementById('edit-end-time-select');
            const roomBookingsToday = currentDailyBookings.filter(b => b['場地名稱'] === booking['場地名稱'] && b['預約ID'] !== booking['預約ID']);
            const startIndex = timeSlots.indexOf(booking['開始時間']);
            populateEndTimeSelect(endTimeSelect, startIndex, roomBookingsToday, booking['結束時間']);
        }
        
        function populateEndTimeSelect(selectElement, startIndex, bookings, currentEndTime = null) {
            selectElement.innerHTML = '';
            for (let i = startIndex + 1; i < timeSlots.length; i++) {
                const slotTime = timeSlots[i];
                const option = document.createElement('option');
                option.value = slotTime;
                option.textContent = slotTime;
                if (currentEndTime && slotTime === currentEndTime) option.selected = true;
                selectElement.appendChild(option);
                const nextBooking = bookings
                    .filter(b => timeToMinutes(b['開始時間']) > timeToMinutes(timeSlots[startIndex]))
                    .sort((a,b) => timeToMinutes(a['開始時間']) - timeToMinutes(b['開始時間']))[0];
                if (nextBooking && timeToMinutes(slotTime) > timeToMinutes(nextBooking['開始時間'])) {
                    selectElement.removeChild(option);
                    break;
                }
            }
             if (selectElement.options.length === 0 && startIndex < timeSlots.length - 1) {
                 const option = document.createElement('option');
                 option.value = timeSlots[startIndex+1];
                 option.textContent = timeSlots[startIndex+1];
                 selectElement.appendChild(option);
            }
        }

        function hideAllModals() {
             bookingModal.classList.add('opacity-0', 'pointer-events-none');
             bookingModal.querySelector('div').classList.add('scale-95');
             editModal.classList.add('opacity-0', 'pointer-events-none');
             editModal.querySelector('div').classList.add('scale-95');
        };

        async function handleApiCall(action, payload, successMessage) {
            showLoader();
            try {
                const response = await fetch(WEB_APP_URL, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action, payload })
                });
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message || '操作失敗');
                
                hideLoader(); 
                hideAllModals();

                renderSchedule(result.data);
                await updateCalendarView(); 
                renderScheduleFromMonthData(datePicker.value); 
                
                await customAlert(successMessage);
            } catch (error) {
                hideLoader(); 
                console.error(`${action} error:`, error);
                await customAlert(`操作失敗：${error.message}`);
            }
        }

        const handleConfirmBooking = () => {
            const name = document.getElementById('booker-name').value.trim();
            const contact = document.getElementById('booker-contact').value.trim();
            const purpose = document.getElementById('booking-purpose').value.trim();
            if (!name || !contact || !purpose) { customAlert('所有欄位皆為必填！'); return; }
            const roomName = document.getElementById('modal-room-name').textContent;
            const startTime = document.getElementById('modal-start-time').textContent;
            const endTime = document.getElementById('end-time-select').value;
            const date = datePicker.value;
            handleApiCall('book', { date, roomName, startTime, endTime, bookerName: name, contact: contact, purpose: purpose }, '預約成功！');
        };
        
        const handleConfirmEdit = () => {
            const bookingId = editModal.dataset.bookingId;
            const name = document.getElementById('edit-booker-name').value.trim();
            const contact = document.getElementById('edit-booker-contact').value.trim();
            const purpose = document.getElementById('edit-booking-purpose').value.trim();
            const endTime = document.getElementById('edit-end-time-select').value;
            if (!name || !contact || !purpose) { customAlert('所有欄位皆為必填！'); return; }
            handleApiCall('edit', { bookingId, endTime, bookerName: name, contact: contact, purpose: purpose }, '修改成功！');
        };
        
        async function handleCancelBooking(bookingId) {
            const booking = currentDailyBookings.find(b => b['預約ID'] === bookingId);
            if(!booking) return;
            const confirmed = await customConfirm(`您確定要取消 ${booking['借用者']} 於 ${booking['開始時間']}-${booking['結束時間']} 的預約嗎？`);
            if (!confirmed) return;
            handleApiCall('cancel', { bookingId: bookingId }, '取消成功！');
        };

        scheduleContainer.addEventListener('click', (e) => {
            const availableCell = e.target.closest('.time-slot-cell.available');
            const bookedSlot = e.target.closest('.booked-slot');
            if (availableCell) {
                const { roomName, timeSlot } = availableCell.dataset;
                showBookingModal(roomName, timeSlot);
            }
            if (bookedSlot) {
                const bookingId = bookedSlot.dataset.bookingId;
                const booking = currentDailyBookings.find(b => b['預約ID'] === bookingId);
                if (booking) showEditModal(booking);
            }
        });

        calendarGrid.addEventListener('click', (e) => {
            const dayCell = e.target.closest('.calendar-day');
            if (dayCell && dayCell.dataset.date && !dayCell.classList.contains('other-month')) {
                datePicker.value = dayCell.dataset.date;
                datePicker.dispatchEvent(new Event('change')); 
            }
        });
        
        prevMonthBtn.addEventListener('click', async () => {
            calendarDate.setMonth(calendarDate.getMonth() - 1);
            await updateCalendarView();
            const firstDayOfMonth = formatDate(calendarDate);
            datePicker.value = firstDayOfMonth;
            renderScheduleFromMonthData(firstDayOfMonth);
        });

        nextMonthBtn.addEventListener('click', async () => {
            calendarDate.setMonth(calendarDate.getMonth() + 1);
            await updateCalendarView();
            const firstDayOfMonth = formatDate(calendarDate);
            datePicker.value = firstDayOfMonth;
            renderScheduleFromMonthData(firstDayOfMonth);
        });

        document.getElementById('confirm-booking-btn').addEventListener('click', handleConfirmBooking);
        document.getElementById('confirm-edit-btn').addEventListener('click', handleConfirmEdit);
        document.getElementById('trigger-cancel-btn').addEventListener('click', () => {
             const bookingId = editModal.dataset.bookingId;
             handleCancelBooking(bookingId);
        });
        
        document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', hideAllModals));
        
        datePicker.addEventListener('change', async () => {
            const newDateStr = datePicker.value;
            const [year, month, day] = newDateStr.split('-').map(Number);
            const newDate = new Date(Date.UTC(year, month - 1, day, 12)); 

            const currentMonth = new Date(Date.UTC(calendarDate.getFullYear(), calendarDate.getMonth(), 1, 12));

            if (newDate.getUTCFullYear() !== currentMonth.getUTCFullYear() || newDate.getUTCMonth() !== currentMonth.getUTCMonth()) {
                calendarDate = new Date(newDate.getUTCFullYear(), newDate.getUTCMonth(), 1);
                await updateCalendarView(); 
            } else {
                renderCalendar(calendarDate, currentMonthBookings);
            }
            
            renderScheduleFromMonthData(newDateStr);
        });

        window.addEventListener('load', async () => {
            const today = new Date();
            const todayStr = formatDate(today);
            datePicker.value = todayStr;
            calendarDate = new Date(today.getFullYear(), today.getMonth(), 1);
            
            await updateCalendarView(); 
            
            renderScheduleFromMonthData(todayStr);
        });
    </script>
</body>
</html>


